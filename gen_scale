#!/usr/bin/nodejs

var ch = require( 'chromatic' );
var fs = require( 'fs' );

function applyTemplate( s, o ) {
	return s.replace(  /\$\{([a-zA-Z0-9_]+)\}/g, function( s0, s1 ) {
		// console.error( s1 );
		s1 = s1.trim();
		if ( s1 in o ) {
			return o[ s1.trim() ];
		} else {
			return '';
		}
	});
}

function gen_flat( notes , trans, postfix, mark_s, mark_e ) {
	var notes_str  = "";
	var lyrics = "";
	for ( var i=0; i<notes.length; i++ ) {
		var note1 = notes[i];
		var note2 = ch.lookup( note1, trans );

		notes_str  += ( note1  + postfix +          " " +  note2 +          " s " );
		lyrics += ( note1  +                    " " +  note2 +          "   " );

		postfix = '';
	}
	return [{
		caption  : '',
		notes    : notes_str,
		lyrics   : lyrics,
	}];
}

function gen_sharp( notes , trans, postfix, mark_s, mark_e ) {
	var result = [];
	var notes_01 = '';
	var notes_02 = '';
	var notes_03 = '';

	var lyrics_01 = '';
	var lyrics_02 = '';
	var lyrics_03 = '';

	for ( var i=0; i<notes.length; i++ ) {
		var note1 = notes[i];
		var note2 = ch.lookup( note1, trans );

		if ( ch.isIrregularAccidental( note2 ) || ch.isDoubleAccidental( note2 ) ) {
			var rnote1 = ch.respell( note1 );
			var rnote2 = ch.respell( note2 );

			notes_01  += (  note1 + postfix + mark_s + " " +  note2 + mark_e + " s " );
			notes_02  += (  note1 + postfix + mark_s + " " + rnote2 + mark_e + " s " );
			notes_03  += ( rnote1 + postfix + mark_s + " " + rnote2 + mark_e + " s " );
			lyrics_01 += (  note1 +                    " " +  note2 +          "   " );
			lyrics_02 += (  note1 +                    " " + rnote2 +          "   " );
			lyrics_03 += ( rnote1 +                    " " + rnote2 +          "   " );
		} else {
			notes_01  += ( note1  + postfix +          " " +  note2 +          " s " );
			notes_02  += ( note1  + postfix +          " " +  note2 +          " s " );
			notes_03  += ( note1  + postfix +          " " +  note2 +          " s " );
			lyrics_01 += ( note1  +                    " " +  note2 +          "   " );
			lyrics_02 += ( note1  +                    " " +  note2 +          "   " );
			lyrics_03 += ( note1  +                    " " +  note2 +          "   " );
		}

		postfix = '';
	}

	result.push({
		caption  : '1. Harmonic Spelling',
		notes    : notes_01,
		lyrics   : lyrics_01,
	});
	result.push({
		caption  : '2. Enharmonic Spelling with Respecting Horizontal Interval Correctness',
		notes    : notes_02,
		lyrics   : lyrics_02,
	});
	result.push({
		caption  : '3. Enharmonic Spelling with Respecting Vertical Interval Correctness',
		notes    : notes_03,
		lyrics   : lyrics_03,
	});
	return result;
}

function createTemplate( arr ) {
	var result = "";

result += `
\\version "2.18.2"
\\include "aaron.ly"
\\include "../chromatic-solfege-gen.ly"
`;

	function createBlock( caption, notes, lyrics ) {
		var result =  "";
		if ( caption ) {
			result +=
`
\\markup \\bold \\italic {
    ${caption}
}
`;
		}

		result +=
`
\\makescore 
  \\relative do' {
    ${notes}
  }
  \\lyricmode {
    ${lyrics}
  }
`;
		return result;
	}

	for ( var i=0; i<arr.length; i++ ) {
		var e= arr[i];
		result += createBlock( e.caption, e.notes, e.lyrics );
	}
	return result.trim();
}




var TAG_START = '\\stau';
var TAG_STOP = '\\stou';
function exec( notes, trans, isSharp, postfix, filename ) {
	var result;
	if ( isSharp ) {
		result = gen_sharp( notes, trans, postfix, TAG_START, TAG_STOP );
	} else {
		result = gen_flat(  notes, trans, postfix, TAG_START, TAG_STOP );
	}
	// console.error( result );

	// console.error( notes, filename );
	// var template = fs.readFileSync( './template.ly', 'utf8' );
	// var output = applyTemplate( template, result );
	var output = createTemplate( result );

	fs.writeFileSync( filename, output, 'utf8' );
	// console.error( filename );

	// process.stdout.write(   + '\n' );
}

function fmt( i, len ) {
	var s = String(i);
	while ( s.length < len ) {
		s ='0' + s; 
	}
	return s;
}

var ASCEND_SHARP  = 'do di re ri mi fa fi sol si la li ti do'.split(' ');
var DESCEND_FLAT  = 'do ra re me mi fa se sol le la te ti do'.split(' ').reverse()
var ASCEND_FLAT   = 'do ra re me mi fa se sol le la te ti do'.split(' ');
var DESCEND_SHARP = 'do di re ri mi fa fi sol si la li ti do'.split(' ').reverse();

function batch() {
	var batch_pg = [
		[ 're', "",   0, ASCEND_FLAT  ,  ],
		[ 're', "'",  0, DESCEND_FLAT ,  ],
		[ 'me', "",   0, ASCEND_FLAT  ,  ],
		[ 'me', "'",  0, DESCEND_FLAT ,  ],
		[ 'mi', "",   0, ASCEND_FLAT  ,  ],
		[ 'mi', "'",  0, DESCEND_FLAT ,  ],
		[ 'fa', "'",  0, ASCEND_FLAT ,   ],
		[ 'fa', "'",  0, DESCEND_FLAT ,  ],

		[ 're', "",   1, ASCEND_SHARP ,  ],
		[ 're', "'",  1, DESCEND_SHARP,  ],
		[ 'me', "",   1, ASCEND_SHARP ,  ],
		[ 'me', "'",  1, DESCEND_SHARP,  ],
		[ 'mi', "",   1, ASCEND_SHARP ,  ],
		[ 'mi', "'",  1, DESCEND_SHARP,  ],
		[ 'fa', "'",  1, ASCEND_SHARP,  ],
		[ 'fa', "'",  1, DESCEND_SHARP,  ],
	];
	var pg=null;
	for ( var i=0; i<batch_pg.length; i++ ) {
		pg = batch_pg[i];
		exec( pg[3] , pg[0], pg[2], pg[1], 'out/pat_' + fmt(i,2) + '.ly' );
	}
}

batch();




// vim: filetype=javascript :

