#!/bin/bash
shopt -s nullglob


echo
echo '====================='
echo 'Generating files...'
echo '====================='
echo

FILES=( "$@" )

# If no file is specified to the arguments, it should default to all scale generators.
if [ ${#FILES[@]} -eq 0 ]; then
	rm out/*
	FILES=( ./ch-* )
fi

# Remove the old generated files.
for  i in  "${FILES[@]}" # "$@";
do
	# echo "${i##*/}"
	NAME="${i##*/}"
	echo "Processing ${NAME} ..."
	# echo "out/${NAME}"-[0-9]*
	rm -v "out/${NAME}"-[0-9]*
	./${NAME}
	echo 
	echo 
done;

# Create the file that include everything
{
	ALL=( ./ch-* )
	for  i in  "${ALL[@]}" 
	do
		echo "\\input{ ly-generated/$(basename $i)-output.tex }"
	done
} > out/all-output.tex

# echo ${#FILES[@]}
# echo ${FILES[*]}
echo
echo '================================'
echo 'Compiling the generated files...'
echo '================================'
echo

function max_proc_count {
   while [ `jobs | wc -l` -gt $1 ]
   do
      sleep 0.5
   done
}

cd out

for NAME in  "${FILES[@]}" # "$@";
do
	echo "Compiling ${NAME} ..."
	for  i in "${NAME}"-[0-9]*.ly # "$@";
	do
		# echo $i
		max_proc_count 5
		echo "${i##*/}"
		lilypond -I /home/ats/Documents/lilypond/include/ "${i##*/}" 2> /dev/null &
	done;
	echo 
	echo 
done;

max_proc_count 1

echo
echo '====================================='
echo 'Compiling the Festival Header Voice  '
echo '====================================='
echo

for NAME in  "${FILES[@]}"
do
	echo "Compiling ${NAME} ..."
	for  i in "${NAME}"-[0-9]*.ftxt
	do
		# echo $i
		max_proc_count 5
		echo "${i##*/}"
		text2wave -eval "(voice_us1_mbrola)"  "${i##*/}" > "${i##*/}.wav" &  # 2> /dev/null &
	done;
	echo 
	echo 
done;



beep

WAV_OUTPUT_FILES=()
for NAME in  "${FILES[@]}" 
do
	WAV_OUTPUT_FILES+=( $NAME-[0-9]*.wav )
	echo "${WAV_OUTPUT_FILES[@]}"
done

vlc "${WAV_OUTPUT_FILES[@]}" &



# lilypond -I /home/ats/Documents/lilypond/include/ *.ly
